#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>

typedef struct{
    char *nameServer;
    char *folder;
    char *ipDiscovery;
    int portDiscovery;
    char *ipPoole;
    int portPoole;
}Poole;

char * read_until(int fd, char end) {
	char *string = NULL;
	char c;
	int i = 0, size;

	while (1) {
		size = read(fd, &c, sizeof(char));
		if(string == NULL){
			string = (char *) malloc(sizeof(char));
		}
		if(c != end && size > 0){
			string = (char *) realloc(string, sizeof(char)*(i + 2));
			string[i++] = c;
		}else{
			break;
		}
	}
	string[i] = '\0';
	return string;
}

int main(int argc, char *argv[]){
    char *buffer;
    char *line;
    Poole poole;

    if (argc != 2) {
        asprintf(&buffer, "ERROR: Expecting one parameter.\n");
        write(1, buffer, strlen(buffer));
        free(buffer);
        return -1;
    }

    //READING POOLE FILE

    int fd_poole = open(argv[1], O_RDONLY);

    if(fd_poole == -1){
        perror("Error opening poole file");
        exit(EXIT_FAILURE);
    }

    line = read_until(fd_poole, '\n');
    poole.nameServer = malloc(sizeof(char) * (strlen(line) + 1));
    strcpy(poole.nameServer, line);
    poole.nameServer[strlen(line)] = '\0';
    free(line);

    line = read_until(fd_poole, '\n');
    poole.folder = malloc(sizeof(char) * (strlen(line) + 1));
    strcpy(poole.folder, line);
    poole.folder[strlen(line)] = '\0';
    free(line);

    line = read_until(fd_poole, '\n');
    poole.ipDiscovery = malloc(sizeof(char) * (strlen(line) + 1));
    strcpy(poole.ipDiscovery, line);
    poole.ipDiscovery[strlen(line)] = '\0';
    free(line);

    line = read_until(fd_poole, '\n');
    poole.portDiscovery = atoi(line);
    free(line);

    line = read_until(fd_poole, '\n');
    poole.ipPoole = malloc(sizeof(char) * (strlen(line) + 1));
    strcpy(poole.ipPoole, line);
    poole.ipPoole[strlen(line)] = '\0';
    free(line);

    line = read_until(fd_poole, '\n');
    poole.portPoole = atoi(line);
    free(line);

    close(fd_poole);

    //PRINTING POOLE FILE

    asprintf(&buffer, "\nFile read correctly:\n");
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Server name - %s\n", poole.nameServer);
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Directory - %s\n", poole.folder);
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Discovery IP - %s\n", poole.ipDiscovery);
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Discovery port - %d\n", poole.portDiscovery);
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Poole IP - %s\n", poole.ipPoole);
    write(1, buffer, strlen(buffer));
    free(buffer);

    asprintf(&buffer, "Poole port - %d\n", poole.portPoole);
    write(1, buffer, strlen(buffer));
    free(buffer);

    return 0;
}
